<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Flappy Bird</title>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: black;
  touch-action: manipulation;
}

canvas { display: block; }

#score {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  font-size: 26px;
  font-weight: bold;
  text-shadow: 2px 2px black;
  text-align: center;
  pointer-events: none;
}

.top {
  top: 15px;
}

.center {
  top: 50%;
}
</style>
</head>

<body>

<div id="score" class="center">Tap to Start</div>
<canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

canvas.width = innerWidth;
canvas.height = innerHeight;

/* Images */
const bg = new Image(); bg.src = "moon.png";
const birdImg = new Image(); birdImg.src = "toppng.com-grey-cartoon-bird-design-600x550.png";
const pipeImg = new Image(); pipeImg.src = "toppng.com-flappy-bird-pipe-transparent-281x1080.png";

/* Bird */
let bird = { x: canvas.width * 0.25, y: canvas.height / 2, w: 44, h: 34, v: 0 };
let gravity = 0.28;
let jump = -6.2;

/* Pipes */
let pipes = [];
let gap = 220;

let baseSpeed = 2;
let speed = baseSpeed;
let speedIncrease = 0.001;

let frame = 0;

/* Game state */
let started = false;
let gameOver = false;
let score = 0;
let highScore = localStorage.getItem("flappyHighScore") || 0;

const scoreDiv = document.getElementById("score");

/* Start / Jump */
function flap() {
  if (!started || gameOver) {
    started = true;
    gameOver = false;
    pipes = [];
    score = 0;
    speed = baseSpeed;
    bird.y = canvas.height / 2;
    bird.v = 0;
    frame = 0;

    addPipe(true); // ✅ أول أنبوبة مظبوطة فعلًا

    scoreDiv.className = "top";
    scoreDiv.innerText = `Score: ${score} | Best: ${highScore}`;
    return;
  }
  bird.v = jump;
}

addEventListener("touchstart", e => {
  e.preventDefault();
  flap();
}, { passive:false });

addEventListener("keydown", e => {
  if (e.code === "Space") flap();
});

/* Pipes */
function addPipe(first = false) {
  let top = first
    ? canvas.height * 0.32   // ✅ وسط الشاشة
    : Math.random() * (canvas.height * 0.35) + canvas.height * 0.2;

  pipes.push({ x: canvas.width, top, passed: false });
}

/* Loop */
function loop() {
  ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);

  if (started && !gameOver) {

    speed += speedIncrease;

    bird.v += gravity;
    bird.y += bird.v;

    if (frame % 130 === 0 && frame !== 0) addPipe();

    pipes.forEach(p => {
      p.x -= speed;

      if (
        bird.x + bird.w > p.x &&
        bird.x < p.x + 80 &&
        (bird.y < p.top || bird.y + bird.h > p.top + gap)
      ) {
        gameOver = true;
        scoreDiv.className = "center";
        scoreDiv.innerText = `Game Over\nTap to Restart\nBest: ${highScore}`;
      }

      if (!p.passed && bird.x > p.x + 40) {
        p.passed = true;
        score++;
        if (score > highScore) {
          highScore = score;
          localStorage.setItem("flappyHighScore", highScore);
        }
        scoreDiv.innerText = `Score: ${score} | Best: ${highScore}`;
      }

      /* Pipes draw */
      ctx.save();
      ctx.translate(p.x + 40, p.top / 2);
      ctx.scale(1, -1);
      ctx.drawImage(pipeImg, -40, -p.top / 2, 80, p.top);
      ctx.restore();

      ctx.drawImage(pipeImg, p.x, p.top + gap, 80, canvas.height);
    });

    pipes = pipes.filter(p => p.x > -100);

    if (bird.y < 0 || bird.y + bird.h > canvas.height) {
      gameOver = true;
      scoreDiv.className = "center";
      scoreDiv.innerText = `Game Over\nTap to Restart\nBest: ${highScore}`;
    }
  }

  ctx.drawImage(birdImg, bird.x, bird.y, bird.w, bird.h);

  frame++;
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
